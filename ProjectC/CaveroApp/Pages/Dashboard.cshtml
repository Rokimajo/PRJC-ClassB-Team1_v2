@page
@using CaveroApp.Areas.Identity.Data
@using System.Security.Claims
@model CaveroApp.Pages.Dashboard
@inject SignInManager<CaveroAppUser> SignInManager
@inject CaveroAppContext Context

@{
    ViewData["Title"] = "Dashboard";
    Layout = "Shared/CaveroLayoutResponsive";
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="css/layout.css" />
    <link rel="stylesheet" href="css/events.css" />
    <link rel="stylesheet" href="css/dashboard.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script type="module" src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
}

@section HeaderContent
{
    @if (SignInManager.IsSignedIn(User))
    {
        var userID = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        var username = Context.Users.Where(x => x.Id == userID).Select(y => y.FirstName).First();
        <h1 style="color: white; font-size: 28px; font-weight:  600; font-family: 'Montserrat', sans-serif;">Welkom terug,
    @username!</h1>
    }
    }

    <!DOCTYPE html>
    <html>

    <head>
    </head>

    <body>
        <div class="main-body">
            <div class="card one">
                <div class="present-box">
                    <p>Aanwezige caverianen vandaag</p>
                    <div class="box-info">
                        <img src="img/image-8-2.png" alt="Person Icon" />
                        <h1>@Model.EmployeeCount</h1>
                    </div>
                </div>
                <div class="present-box">
                    <p>Aantal events deze week</p>
                    <div class="box-info">
                        <img src="img/image-8-3.png" alt="Event Icon" />
                        <h1>@Model.EventCount</h1>
                    </div>
                </div>
            </div>
            <div class="card two">
                <!-- Reusing event modal because it fits very well with a check in form.-->
                <div class="event-modal-content" style="max-width: 400px; margin: 10px;">
                    <div class="event-modal-header">
                        <h1 style="justify-content: flex-start">Inchecken</h1>
                    </div>
                    <div class="event-modal-header">
                        <p
                            style="justify-content: flex-start; color: var(--collection-1-cavero-blackish-grey); opacity: 80%; font-weight:  500;">
                            Kies hier met de datepicker een datum om in te checken.</p>
                    </div>
                    <div class="line"></div>
                    <!-- -->
                    <form id="checkInForm" asp-page-handler="DateCheckInUser" method="post">
                        <div class="event-modal-create">
                            <div class="event-modal-row">
                                <input id="dateCheckIn" placeholder="Kies een datum.." type="text" required
                                    oninput="validateCheckInDate()" onblur="validateCheckInDate()"
                                    asp-for="CheckModel.Date" />
                                <span class="error-message" id="dateCheckInError"></span>
                            </div>
                            <div class="event-modal-row">
                                <button id="dateCheckInButton" class="button create-event" type="submit">
                                    <p>CHECK IN OP DATUM</p>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <!-- My Events: -->
            <div class="card three">
                <div class="my-events-container" style="border: 2px solid black;">
                    <div class="scroll-container">
                        <h2 class="my-events-title">My Events:</h2>
                        <h2 class="my-events-date">@DateTime.UtcNow.ToString("dd-MM-yyyy")</h2>
                        <div class="my-events-table">
                            <div class="my-events-column">
                                @foreach (var userEvent in Model.EventInfo)
                            {
                                <li>
                                    <div class="event-card" style="border: 2px solid black;">
                                        <h1>@userEvent.title</h1>
                                        <p>Locatie: @userEvent.location</p>
                                        <p>Tijd: @userEvent.start_time.ToString(@"hh\:mm") -
                                            @userEvent.end_time.ToString(@"hh\:mm")
                                        </p>
                                    </div>
                                </li>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    </div>
    </div>
    </div>
</body>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        flatpickr("#dateCheckIn", {
            enableTime: false,
            dateFormat: "d-m-Y",
            minDate: "today",
            disable: [
                function (date) {
                    // Disable weekends (Saturday and Sunday)
                    return (date.getDay() === 0 || date.getDay() === 6);
                }
            ],
        });
        const dateCheckButton = document.getElementById('dateCheckInButton');
        const form = document.getElementById('checkInForm');

        dateCheckButton.addEventListener('click', function (event) {
            const dateCheckError = document.getElementById('dateCheckInError');
            validateCheckInDate(event);
            if (!form.checkValidity() || dateCheckError.textContent !== '') {
                // Prevent form submission if there are validation errors
                event.preventDefault();
            }
        });
    });



    function validateCheckInDate(event) {
        const dateCheckInput = document.getElementById('dateCheckIn');
        const dateCheckError = document.getElementById('dateCheckInError');
        if (dateCheckInput.value === '') {
            if (event !== undefined)
                event.preventDefault();
            dateCheckError.textContent = 'U moet eerst een datum invullen.';
            dateCheckError.style.display = 'inline';
        }
        else {
            $.ajax({
                url: '/Dashboard?handler=CheckDate',
                data: { 'date': dateCheckInput.value },
                success: function (isValid) {
                    if (isValid) {
                        dateCheckError.textContent = '';
                        dateCheckError.style.display = 'none';
                    } else {
                        dateCheckError.textContent = 'U bent al ingecheckt op deze dag.';
                        dateCheckError.style.display = 'inline';
                        // The date is not valid, show an error message.
                    }
                }
            });
        }
    }
</script>

</html>
